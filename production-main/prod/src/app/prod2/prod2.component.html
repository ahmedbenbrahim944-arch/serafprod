<div class="full-screen-layout text-white relative overflow-hidden">
  <!-- Background avec particules -->
  <div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-10"
       style="background-image: url('https://www.tannerag.ch/Marketing/News%20and%20Social%20Media/38748/image-thumb__38748__contentImageLarge/production-process.e47f5cea.jpg')">
  </div>

  <!-- Système de particules -->
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    <div *ngFor="let particle of particles()" 
         class="particle absolute rounded-full bg-cyan-400/40"
         [style.left]="particle.left"
         [style.animation-delay]="particle.animationDelay"
         [style.width]="particle.size"
         [style.height]="particle.size"
         [style.opacity]="particle.opacity">
    </div>
  </div>

  <div class="relative z-10 h-screen flex flex-col">
    <!-- Header principal -->
    <header class="header-industrial py-3 px-4 sm:px-6">
      <div class="flex justify-between items-center">
        <button 
          (click)="goBackToLogin()"
          class="px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-red-600 hover:bg-red-500 text-white flex items-center text-xs sm:text-sm">
          <svg class="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span class="hidden sm:inline">Retour</span>
        </button>

        <div class="text-center flex-1">
          <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-cyan-400">PLANIFICATION DES LIGNES</h1>
        </div>

        <div class="w-16 sm:w-32"></div>
      </div>
    </header>

    <!-- Contenu principal -->
    <div class="flex-1 flex overflow-hidden">
      
      <!-- Affichage des lignes de production -->
      <div *ngIf="!selectedLigne()" class="flex-1 p-2 sm:p-4 overflow-auto">
        <div class="max-w-[95%] mx-auto">
          
          <!-- Barre de recherche -->
          <div class="mb-4 sm:mb-6 flex justify-center">
            <div class="search-container p-2 sm:p-3 rounded-lg w-full max-w-md sm:w-96">
              <div class="flex items-center">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input 
                  type="text" 
                  [value]="searchLineQuery()"
                  (input)="onSearchLineChange($event)"
                  placeholder="Rechercher une ligne..." 
                  class="search-input flex-1 text-sm sm:text-base">
                <button 
                  *ngIf="searchLineQuery()"
                  (click)="clearLineSearch()"
                  class="ml-2 text-gray-400 hover:text-white transition-colors">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="filteredLines().length === 0" class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-base sm:text-lg">Aucune ligne trouvée</p>
          </div>

          <!-- Grille responsive -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            <div *ngFor="let line of filteredLines()" 
                 (click)="onLigneSelected(line)"
                 class="line-card-large rounded-xl cursor-pointer">
              <div class="image-container-large">
                <img [src]="line.imageUrl" [alt]="line.ligne">
                <div class="line-overlay-large">
                  <div class="line-name-large">{{ line.ligne }}</div>
                  <div class="text-cyan-200 text-xs sm:text-sm mt-2">{{ line.referenceCount }} références</div>
                </div>
                <div [class.status-badge-active]="line.isActive" 
                     [class.status-badge-inactive]="!line.isActive"
                     class="status-badge">
                  {{ line.isActive ? 'Active' : 'Inactive' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Affichage de la planification -->
      <div *ngIf="selectedLigne() && !selectedReferenceDetails()" class="flex-1 flex relative">
        
        <!-- BOUTON TOGGLE SIDEBAR -->
        <button 
          *ngIf="selectedLigne()"
          (click)="toggleSidebar()"
          class="toggle-sidebar-btn fixed z-30 bg-cyan-600 hover:bg-cyan-500 text-white rounded-r-lg transition-all duration-300 lg:hidden"
          [class.sidebar-open]="sidebarVisible()">
          <svg *ngIf="!sidebarVisible()" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          <svg *ngIf="sidebarVisible()" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- Sidebar des semaines -->
        <div 
          class="weeks-sidebar h-full overflow-y-auto custom-scrollbar transition-transform duration-300 lg:transform-none"
          [class.sidebar-hidden]="!sidebarVisible()"
          [class.sidebar-visible]="sidebarVisible()">
          <div class="p-3 sm:p-4">
            <button 
              (click)="backToLines()"
              class="w-full mb-4 sm:mb-6 px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-white flex items-center justify-center text-xs sm:text-sm">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Retour aux lignes
            </button>

            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-cyan-900/20 rounded-lg border border-cyan-700/30">
              <h3 class="font-bold text-cyan-400 text-lg sm:text-xl mb-2">{{ selectedLigne()!.ligne }}</h3>
              <p class="text-gray-300 text-xs sm:text-sm">{{ selectedLigne()!.referenceCount }} références disponibles</p>
            </div>

            <h4 class="text-cyan-300 font-semibold mb-3 sm:mb-4 text-xs sm:text-sm uppercase tracking-wider">Semaines disponibles</h4>
            <div class="space-y-2">
              <div *ngFor="let week of getAvailableWeeks()" 
                   (click)="onWeekSelected(week.number)"
                   [class.active]="selectedWeek() === week.number"
                   class="week-item p-2 sm:p-3 rounded-lg cursor-pointer border border-gray-600/30">
                <div class="font-bold text-white text-base sm:text-lg">Semaine {{ week.number }}</div>
                <div class="text-gray-400 text-xs mt-1">{{ week.startDate | date:'dd/MM' }} - {{ week.endDate | date:'dd/MM' }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Overlay pour fermer sidebar -->
        <div 
          *ngIf="sidebarVisible()" 
          class="sidebar-overlay lg:hidden"
          (click)="toggleSidebar()">
        </div>

        <!-- Contenu de la semaine -->
        <div class="flex-1 p-3 sm:p-4 md:p-6 overflow-auto custom-scrollbar">
          <div *ngIf="weekPlanification()" class="mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
              <div>
                <h2 class="text-xl sm:text-2xl font-bold text-cyan-400 mb-2">
                  {{ selectedLigne()!.ligne }} - Semaine {{ selectedWeek() }}
                </h2>
                <p class="text-gray-400 text-sm sm:text-base">{{ filteredWeekPlanification()!.startDate | date:'dd/MM/yyyy' }} au {{ filteredWeekPlanification()!.endDate | date:'dd/MM/yyyy' }}</p>
              </div>
              
              <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:space-x-4">
                <div class="search-container p-2 sm:p-3 rounded-lg w-full sm:w-64">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input 
                      type="text" 
                      [value]="searchReferenceQuery()"
                      (input)="onSearchReferenceChange($event)"
                      placeholder="Rechercher référence..." 
                      class="search-input flex-1 text-sm sm:text-base">
                    <button 
                      *ngIf="searchReferenceQuery()"
                      (click)="clearReferenceSearch()"
                      class="ml-2 text-gray-400 hover:text-white transition-colors">
                      <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <button 
                  (click)="toggleEditMode()"
                  [class.bg-green-600]="!isEditing()"
                  [class.bg-blue-600]="isEditing()"
                  class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-all duration-300 text-white flex items-center justify-center text-sm sm:text-base">
                  <svg *ngIf="!isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  <svg *ngIf="isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  {{ isEditing() ? 'Enregistrer' : 'Modifier' }}
                </button>
              </div>
            </div>
          </div>
 <p class="text-black"> C : commander / M : Modifier / DP : Déclaration production / DM : Déclaration Magasin / Δ : Delta /
            NB OP : Nombre d'opérateurs
          </p>

          <!-- Tableau de planification -->
          <div *ngIf="filteredWeekPlanification()" 
               class="table-responsive-container rounded-xl border-2 border-gray-700 bg-slate-900/60 shadow-2xl"
               #tableContainer
               [class.scrollable]="isScrollable()"
               [class.scrolled]="isScrolled()"
               [class.scrolled-end]="isScrolledEnd()"
               [class.scrolled-start]="!isScrolled()">
            
            <div class="table-scroll-wrapper" 
                 #scrollWrapper
                 (scroll)="onTableScroll($event)"
                 (touchstart)="onTouchStart($event)"
                 (touchmove)="onTouchMove($event)"
                 (touchend)="onTouchEnd()">
              
              <div class="planning-table-min-width">
                <table class="week-planning-table w-full">
                 <!-- Remplacer la section <thead> du tableau par ceci : -->
<!-- Version avec possibilité d'éditer le NB OP -->
<thead>
  <tr>
    <th class="sticky left-0 z-20 sticky-cell border-2 border-gray-700" rowspan="2">RÉFÉRENCES</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">C/R</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">OF</th>
    
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header" colspan="1">
  <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
    <div class="text-center">
      <div class="font-bold text-cyan-400 capitalize text-sm sm:text-base">{{ day }}</div>
      <!-- CHANGER text-gray-300 EN text-black -->
      <div class="text-xs sm:text-sm text-black mt-1">{{ getDayDateCorrected(weekDays[i], i) | date:'dd/MM' }}</div>
    </div>
     <button 
            (click)="onPersonIconClick(day)"
            class="ml-2 p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors"
            title="Saisie rapport production">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </button>
  </div>
</th>
    </ng-container>
  </tr>
  <tr>
    <ng-container *ngFor="let day of weekDays">
      <th class="text-center border-2 border-gray-700 day-header">
        <div class="flex flex-col items-center justify-center px-2 py-2">
          <!-- Badge NB OP -->
          <div class="text-black  "
               >
           <span >NB OP</span>
          </div>
          
          <!-- Mode édition : Input -->
          
          
          <!-- Mode lecture : Affichage avec code couleur -->
          <div *ngIf="!isEditing()" 
               class="text-black text-base"
              >
            {{ getAverageOperators(day) }}
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
</thead>
                <tbody>
  <ng-container *ngFor="let ref of filteredWeekPlanification()!.references">
    <!-- Ligne C -->
    <tr class="border-b border-gray-700/50">
  <td class="sticky left-0 z-10 sticky-cell border-2 border-gray-700 font-semibold whitespace-nowrap px-2 sm:px-4 py-3 sm:py-4 text-sm sm:text-base" rowspan="5">
    {{ ref.reference }}
  </td>
  <td class="text-center font-bold text-blue-700 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base bg-blue-100">C</td> <!-- Ajout de bg-blue-100 -->
  <td class="text-center font-mono text-white border-2 border-gray-700 py-3 sm:py-4 vertical-text-cell" rowspan="5">
    <div class="vertical-text-wrapper">
      <ng-container *ngIf="getDayEntry(ref, 'lundi')">
        <!-- OF - LECTURE SEULE -->
        <span class="vertical-text-value">{{ getDayEntry(ref, 'lundi')!.of }}</span>
      </ng-container>
    </div>
  </td>
  <ng-container *ngFor="let day of weekDays">
    <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
      <!-- C - LECTURE SEULE -->
      <span class="text-white font-bold text-base sm:text-lg value-display">{{ getDayEntry(ref, day)!.c }}</span>
      <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
    </td>
  </ng-container>
</tr>
    
    <!-- Ligne M - MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">M</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- M - MODIFIABLE EN MODE ÉDITION -->
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.m"
                 (input)="updateDayEntry(ref, day, 'm', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" class="text-white font-bold text-base sm:text-lg value-display">{{ getDayEntry(ref, day)!.m }}</span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DP - MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DP</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- DP - MODIFIABLE EN MODE ÉDITION -->
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.dp"
                 (input)="updateDayEntry(ref, day, 'dp', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" class="text-white font-bold text-base sm:text-lg value-display">{{ getDayEntry(ref, day)!.dp }}</span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DM - NON MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DM</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- DM - LECTURE SEULE -->
          <span class="text-white font-bold text-base sm:text-lg value-display">{{ getDayEntry(ref, day)!.dm }}</span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne Delta - NON MODIFIABLE -->
    <tr class="border-b-2 border-gray-700">
      <td class="text-center font-bold text-cyan-400 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">Δ</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <button *ngIf="getDayEntry(ref, day)"
                  (click)="openCausesModal(ref, day)"
                  type="button"
                  [ngClass]="{
                    'delta-excellent': getDayEntry(ref, day)!.delta >= 70,
                    'delta-good': getDayEntry(ref, day)!.delta >= 50 && getDayEntry(ref, day)!.delta < 70,
                    'delta-average': getDayEntry(ref, day)!.delta >= 20 && getDayEntry(ref, day)!.delta < 50,
                    'delta-poor': getDayEntry(ref, day)!.delta < 20
                  }"
                  class="font-bold delta-value text-base sm:text-lg w-full px-2 py-2 rounded-lg hover:scale-105 transition-transform cursor-pointer hover:shadow-lg relative group">
            {{ getDayEntry(ref, day)!.delta }}
            
            <!-- Indicateur de causes enregistrées -->
            <span *ngIf="getDayEntry(ref, day)!.causes" 
                  class="absolute top-1 right-1 w-2 h-2 bg-green-400 rounded-full"
                  title="Causes enregistrées"></span>
          </button>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
  </ng-container>
</tbody>
                </table>
              </div>
            </div>
            
            <!-- Indicateur de défilement -->
            <div class="scroll-indicator" 
                 *ngIf="showScrollIndicator()"
                 (click)="scrollToStart()">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
              </svg>
              Glisser pour voir les jours
            </div>
          </div>

          <div *ngIf="selectedLigne() && !weekPlanification()" class="h-full flex items-center justify-center">
            <div class="text-center text-gray-400">
              <svg class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <p class="text-base sm:text-lg mb-2">Sélectionnez une semaine</p>
              <p class="text-xs sm:text-sm text-gray-500">pour voir la planification</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulaire de Saisie Rapport Production -->
<!-- Formulaire de Saisie Rapport Production - MODIFIÉ -->
<div *ngIf="showProductionForm()" class="production-form-overlay fixed inset-0 bg-gray-900/90 flex items-center justify-center z-50 p-4">
  <div class="production-form-container bg-white rounded-xl shadow-2xl w-full max-w-7xl max-h-[90vh] overflow-y-auto flex flex-col">
    
    <!-- Header - MODIFIÉ -->
    <div class="bg-blue-600 p-4 flex justify-between items-center flex-shrink-0 sticky top-0 z-50">
      <h2 class="text-xl font-bold text-white">SAISIE RAPPORT PRODUCTION - MULTI-OPÉRATEURS</h2>
      <button (click)="closeProductionForm()" class="text-white hover:text-blue-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="flex flex-1 min-h-0">
      <!-- Section de sélection des opérateurs - MODIFIÉ -->
      <div class="w-1/4 bg-gray-50 p-4 overflow-y-auto border-r border-gray-300">
        <h3 class="text-blue-600 font-semibold text-lg mb-3">Sélection des Opérateurs</h3>
        
        <!-- Date - MODIFIÉ -->
        <div class="mb-3">
          <label class="block text-blue-600 font-semibold mb-2 text-sm">DATE</label>
          <input 
            type="text" 
            [value]="currentDate()"
            class="w-full bg-gray-100 border border-blue-400 rounded-lg px-3 py-2 text-gray-800 focus:outline-none focus:border-blue-500"
            readonly>
        </div>

        <!-- Ligne sélectionnée - MODIFIÉ -->
        <div class="mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
          <h4 class="font-bold text-blue-600 text-xs mb-1">LIGNE SÉLECTIONNÉE</h4>
          <p class="text-gray-800 text-sm font-semibold">{{ selectedLigne()?.ligne }}</p>
        </div>

        <!-- Barre de recherche - MODIFIÉ -->
        <div class="mb-3">
          <div class="search-container p-2 rounded-lg bg-gray-100 border border-gray-300">
            <div class="flex items-center">
              <svg class="w-4 h-4 text-gray-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              <input 
                type="text" 
                [value]="searchRecordQuery()"
                (input)="onSearchRecordChange($event)"
                placeholder="Rechercher matricule..." 
                class="search-input flex-1 bg-transparent text-gray-800 text-sm focus:outline-none">
            </div>
          </div>
        </div>

        <!-- Boutons de sélection globale - MODIFIÉ -->
        <div class="flex space-x-2 mb-3">
          <button 
            (click)="selectAllOperators()"
            class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-semibold transition-colors">
            Tout
          </button>
          <button 
            (click)="deselectAllOperators()"
            class="flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded text-xs font-semibold transition-colors">
            Aucun
          </button>
        </div>

        <!-- Liste des opérateurs - MODIFIÉ -->
        <div class="space-y-1 max-h-64 overflow-y-auto operator-list">
          <div *ngFor="let operator of filteredOperatorsForSelection()" 
               class="p-2 rounded transition-colors cursor-pointer hover:bg-blue-100"
               [class.bg-blue-100]="selectedMatricules().includes(operator.matricule)"
               (click)="toggleMatriculeSelection(operator.matricule)">
            <div class="flex items-center">
              <div class="mr-2">
                <input 
                  type="checkbox" 
                  [checked]="selectedMatricules().includes(operator.matricule)"
                  (change)="toggleMatriculeSelection(operator.matricule)"
                  class="w-3 h-3 text-blue-600 bg-white border-gray-400 rounded focus:ring-blue-500">
              </div>
              <div class="flex-1">
                <div class="font-semibold text-gray-800 text-xs">{{ operator.matricule }}</div>
                <div class="text-xs text-gray-600">{{ operator.nom }} {{ operator.prenom }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Résumé de sélection - MODIFIÉ -->
        <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
          <div class="text-center">
            <span class="text-blue-600 font-semibold text-xs">Opérateurs sélectionnés:</span>
            <div class="text-gray-800 font-bold text-base mt-1">{{ selectedMatricules().length }}</div>
          </div>
        </div>

        <!-- Bouton voir enregistrements - MODIFIÉ -->
        <button 
          (click)="toggleRecordsPanel()"
          class="w-full mt-3 px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded text-xs font-semibold transition-colors flex items-center justify-center">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          Voir Enregistrements
        </button>
      </div>

      <!-- Contenu principal - MODIFIÉ -->
      <div class="flex-1 p-4 overflow-y-auto bg-white">
        <div *ngIf="selectedMatricules().length === 0" class="h-full flex items-center justify-center">
          <div class="text-center text-gray-500">
            <svg class="w-12 h-12 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
            <p class="text-base font-medium">Sélectionnez des opérateurs pour commencer la saisie</p>
            <p class="text-sm text-gray-400 mt-1">Utilisez les cases à cocher à gauche</p>
          </div>
        </div>

        <!-- Tableau de saisie - MODIFIÉ -->
        <div *ngIf="selectedMatricules().length > 0" class="space-y-3">
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full text-sm">
               <thead class="bg-white sticky top-0 z-10 border-b border-gray-300">
                <tr>
                  <th class="px-3 py-2 text-left text-blue-600 font-semibold ">Opérateur</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold">Phase 1</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Phase 2</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Phase 3</th>
                  <th class="px-2 py-2 text-center text-blue-600 font-semibold ">Heures</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let matricule of selectedMatricules()" 
                    class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
                  
                  <!-- Opérateur -->
                  <td class="px-3 py-2">
                    <div class="font-semibold text-gray-800 text-sm">{{ getSafeOperatorFormData(matricule).nomPrenom }}</div>
                    <div class="text-xs text-gray-500">{{ matricule }}</div>
                  </td>
                  
                  <!-- Phase 1 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 0)"
                        (change)="updateOperatorPhase(matricule, 0, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 1</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 0)"
                          (input)="updateOperatorPhaseHeures(matricule, 0, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Phase 2 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 1)"
                        (change)="updateOperatorPhase(matricule, 1, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 2</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 1)"
                          (input)="updateOperatorPhaseHeures(matricule, 1, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Phase 3 -->
                  <td class="px-2 py-2">
                    <div class="space-y-1">
                      <select 
                        [value]="getOperatorPhaseValue(matricule, 2)"
                        (change)="updateOperatorPhase(matricule, 2, $any($event.target).value)"
                        class="w-full bg-white border border-blue-300 rounded px-2 py-1 text-gray-800 text-xs focus:outline-none focus:border-blue-500">
                        <option value="">Phase 3</option>
                        <option *ngFor="let phase of availablePhases()" [value]="phase">
                          {{ phase }}
                        </option>
                      </select>
                      <div class="flex items-center space-x-1">
                        <span class="text-xs text-gray-600 whitespace-nowrap">Heures:</span>
                        <input 
                          type="number" 
                          [value]="getOperatorPhaseHeures(matricule, 2)"
                          (input)="updateOperatorPhaseHeures(matricule, 2, $any($event.target).value)"
                          min="0"
                          max="8"
                          step="0.5"
                          placeholder="0"
                          class="w-14 bg-white border border-blue-300 rounded px-1 py-0.5 text-gray-800 text-xs text-center focus:outline-none focus:border-blue-500">
                      </div>
                    </div>
                  </td>
                  
                  <!-- Total Heures -->
                  <td class="px-2 py-2">
                    <div class="text-center">
                      <div class="text-green-600 font-bold text-base">
                        {{ getSafeOperatorFormData(matricule).totalHeures }}h
                      </div>
                      <div class="text-xs text-gray-500 mt-0.5">
                        {{ 8 - getSafeOperatorFormData(matricule).totalHeures }}h restantes
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Boutons d'action - MODIFIÉ -->
          <div class="flex justify-between pt-3 border-t border-gray-300">
            <button 
              (click)="closeProductionForm()"
              class="px-6 py-2 bg-red-500 hover:bg-red-600 text-white rounded font-semibold text-sm transition-colors">
              Annuler
            </button>
            <button 
              (click)="saveAllProductionRecords()"
              class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded font-semibold text-sm transition-colors">
              Sauvegarder ({{ selectedMatricules().length }})
            </button>
          </div>
        </div>
      </div>

      <!-- Panneau des enregistrements - MODIFIÉ -->
      <div *ngIf="showRecordsPanel()" class="w-1/3 bg-gray-50 p-4 overflow-y-auto border-l border-gray-300">
        <div class="flex justify-between items-center mb-3">
          <h3 class="text-blue-600 font-semibold text-base">Enregistrements du {{ currentDate() }}</h3>
          <button 
            (click)="toggleRecordsPanel()"
            class="text-gray-500 hover:text-gray-700 transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <div class="space-y-2">
          <div *ngFor="let record of filteredProductionRecords()" 
               (click)="showRecordDetails(record)"
               class="bg-white p-2 rounded border border-gray-300 hover:border-blue-400 transition-colors cursor-pointer">
            <div class="flex justify-between items-start mb-1">
              <div>
                <span class="text-blue-600 font-semibold text-xs">{{ record.matricule }}</span>
                <span class="text-gray-800 ml-1 text-xs">- {{ record.nomPrenom }}</span>
              </div>
              <span class="text-green-600 font-semibold text-xs">{{ record.totalHeures }}h</span>
            </div>
            
            <div class="text-xs text-gray-600">
              <div>Ligne: {{ record.ligne1 }}</div>
              <div class="mt-0.5">
                <span class="text-blue-500">Phases:</span>
                <span class="ml-1">{{ formatPhases(record.phasesLigne1) }}</span>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="filteredProductionRecords().length === 0" class="text-center text-gray-400 py-6">
          <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
          </svg>
          <p class="text-sm">Aucun enregistrement pour cette date</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de détails des enregistrements (inchangé) -->
<div *ngIf="showRecordsDetails() && selectedRecordForDetails()" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
  <!-- ... (le code de la modal reste inchangé) ... -->
</div>

<!-- Modal des 5M Causes - VERSION ULTRA GRANDE -->

<div *ngIf="showCausesModal()" 
     class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
  
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl border-2 border-blue-500">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 flex justify-between items-center rounded-t-xl">
      <div>
        <h2 class="text-xl font-bold text-white">ANALYSE DES CAUSES - 5M</h2>
        <p class="text-blue-100 text-sm mt-1" *ngIf="selectedEntryForCauses()">
          {{ selectedEntryForCauses()!.reference.reference }} - 
          {{ selectedEntryForCauses()!.day | titlecase }}
        </p>
      </div>
      <button (click)="closeCausesModal()" 
              type="button"
              class="text-white hover:text-blue-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Contenu principal -->
    <div class="p-4 space-y-4 max-h-[100vh] overflow-y-auto">
      
      <!-- M1: Matière première -->
      <div class="bg-blue-50 rounded-lg p-4 border border-blue-300">
        <h3 class="text-lg font-bold text-blue-700 mb-3">M1: Matière première</h3>
        
        <div class="space-y-3">
          <div class="relative">
            <label class="block text-blue-600 text-sm font-semibold mb-1">Rechercher référence MP</label>
            <input 
              type="text"
              [value]="currentMPReference()"
              (input)="onSearchMPChange($event)"
              (focus)="showMPSuggestions.set(true)"
              (blur)="closeMPSuggestions()"
              placeholder="Tapez pour rechercher..."
              class="w-full bg-white border border-blue-300 rounded-lg px-3 py-2 text-gray-800 text-sm focus:outline-none focus:border-blue-500"
              autocomplete="off">
            
            <!-- Suggestions -->
            <div *ngIf="showMPSuggestions() && filteredMPRefs().length > 0" 
                 class="absolute z-50 w-full mt-1 bg-white border border-blue-300 rounded-lg shadow-lg max-h-40 overflow-y-auto">
              <div *ngFor="let ref of filteredMPRefs()" 
                   (mousedown)="selectMPReference(ref)"
                   class="px-3 py-2 text-gray-700 hover:bg-blue-50 cursor-pointer transition-colors border-b border-blue-50 last:border-b-0 text-sm">
                {{ ref }}
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-blue-600 text-sm font-semibold mb-1">Référence</label>
              <div class="bg-white border border-blue-300 rounded-lg px-3 py-2 text-gray-800 text-sm font-semibold">
                {{ currentMPReference() || '---' }}
              </div>
            </div>
            
            <div>
              <label class="block text-blue-600 text-sm font-semibold mb-1">Quantité</label>
              <input 
                type="number" 
                [value]="currentMPQuantite()"
                (input)="updateMPQuantite($any($event.target).value)"
                min="0"
                placeholder="0"
                class="w-full bg-white border border-blue-300 rounded-lg px-3 py-2 text-gray-800 text-sm text-center focus:outline-none focus:border-blue-500">
            </div>
          </div>
          
          <button 
            (click)="addMatierePremiereReference()"
            type="button"
            class="w-full p-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors text-sm font-semibold"
            [disabled]="!currentMPReference() || currentMPQuantite() <= 0">
            <div class="flex items-center justify-center">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Ajouter la référence
            </div>
          </button>
          
          <!-- Liste des références -->
          <div *ngIf="hasMatierePremierReferences()" class="max-h-32 overflow-y-auto">
            <h4 class="text-sm font-bold text-blue-700 mb-2">Références ajoutées ({{ currentCauses().m1References.length }})</h4>
            
            <div *ngFor="let mpRef of currentCauses().m1References; let i = index" 
                 class="bg-white rounded p-2 mb-1 border border-blue-200">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-gray-800 text-sm font-semibold">{{ mpRef.reference }}</div>
                  <div class="text-blue-600 text-xs">Quantité: {{ mpRef.quantite }}</div>
                </div>
                <button 
                  (click)="removeMatierePremiereReference(i)"
                  type="button"
                  class="p-1 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Total M1 -->
          <div class="bg-blue-100 p-3 rounded border border-blue-300">
            <div class="flex items-center justify-between">
              <span class="text-blue-700 font-semibold text-sm">Total M1:</span>
              <span class="text-gray-900 font-bold text-lg">
                {{ getTotalM1References() }}
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Autres causes en grille 2x2 -->
      <div class="grid grid-cols-2 gap-3">
        
        <!-- M2: Absence -->
        <div class="bg-red-50 rounded-lg p-3 border border-red-300">
          <h4 class="text-red-700 font-bold text-sm mb-2">M2: Absence</h4>
          <div class="flex items-center space-x-2 mb-2">
            <button (click)="decrementCause('m2Absence')"
                    type="button"
                    class="p-1 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
              </svg>
            </button>
            
            <input type="number" 
                   [value]="currentCauses().m2Absence"
                   (input)="updateCause('m2Absence', $any($event.target).value)"
                   min="0"
                   class="flex-1 bg-white border border-red-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-red-500">
            
            <button (click)="incrementCause('m2Absence')"
                    type="button"
                    class="p-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
            </button>
          </div>
          <div class="text-red-700 font-bold text-center text-lg">
            {{ currentCauses().m2Absence }}
          </div>
        </div>
        
        <!-- M2: Rendement -->
        <div class="bg-orange-50 rounded-lg p-3 border border-orange-300">
          <h4 class="text-orange-700 font-bold text-sm mb-2">M2: Rendement</h4>
          <div class="flex items-center space-x-2 mb-2">
            <button (click)="decrementCause('m2Rendement')"
                    type="button"
                    class="p-1 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
              </svg>
            </button>
            
            <input type="number" 
                   [value]="currentCauses().m2Rendement"
                   (input)="updateCause('m2Rendement', $any($event.target).value)"
                   min="0"
                   class="flex-1 bg-white border border-orange-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-orange-500">
            
            <button (click)="incrementCause('m2Rendement')"
                    type="button"
                    class="p-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
            </button>
          </div>
          <div class="text-orange-700 font-bold text-center text-lg">
            {{ currentCauses().m2Rendement }}
          </div>
        </div>
        
        <!-- M4: Maintenance -->
        <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-300">
          <h4 class="text-yellow-700 font-bold text-sm mb-2">M4: Maintenance</h4>
          <div class="flex items-center space-x-2 mb-2">
            <button (click)="decrementCause('m4Maintenance')"
                    type="button"
                    class="p-1 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
              </svg>
            </button>
            
            <input type="number" 
                   [value]="currentCauses().m4Maintenance"
                   (input)="updateCause('m4Maintenance', $any($event.target).value)"
                   min="0"
                   class="flex-1 bg-white border border-yellow-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-yellow-500">
            
            <button (click)="incrementCause('m4Maintenance')"
                    type="button"
                    class="p-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
            </button>
          </div>
          <div class="text-yellow-700 font-bold text-center text-lg">
            {{ currentCauses().m4Maintenance }}
          </div>
        </div>
        
        <!-- M5: Qualité -->
        <div class="bg-purple-50 rounded-lg p-3 border border-purple-300">
          <h4 class="text-purple-700 font-bold text-sm mb-2">M5: Qualité</h4>
          <div class="flex items-center space-x-2 mb-2">
            <button (click)="decrementCause('m5Qualite')"
                    type="button"
                    class="p-1 bg-red-500 hover:bg-red-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
              </svg>
            </button>
            
            <input type="number" 
                   [value]="currentCauses().m5Qualite"
                   (input)="updateCause('m5Qualite', $any($event.target).value)"
                   min="0"
                   class="flex-1 bg-white border border-purple-300 rounded px-2 py-1 text-gray-800 text-sm text-center focus:outline-none focus:border-purple-500">
            
            <button (click)="incrementCause('m5Qualite')"
                    type="button"
                    class="p-1 bg-green-500 hover:bg-green-600 text-white rounded transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
            </button>
          </div>
          <div class="text-purple-700 font-bold text-center text-lg">
            {{ currentCauses().m5Qualite }}
          </div>
        </div>
        
      </div>
      
      <!-- Section Écart -->
      <div class="bg-blue-100 rounded-lg p-4 border border-blue-300">
        <div class="text-center">
          <div class="text-blue-700 font-bold text-lg mb-1">Écart à justifier</div>
          <div class="text-3xl font-bold text-blue-800 mb-2">{{ getEcartCDP() }}</div>
          
          <div class="flex justify-between items-center">
            <div>
              <div class="text-blue-600 text-sm font-semibold">Total des causes</div>
              <div class="text-2xl font-bold" 
                   [class.text-green-600]="getTotalCauses() === getEcartCDP()"
                   [class.text-yellow-600]="getTotalCauses() > getEcartCDP()"
                   [class.text-red-600]="getTotalCauses() < getEcartCDP()">
                {{ getTotalCauses() }}
              </div>
            </div>
            
            <div class="text-right">
              <div class="text-blue-600 text-sm font-semibold">Différence</div>
              <div class="text-xl font-bold">{{ getDifferenceRestante() }}</div>
            </div>
          </div>
        </div>
      </div>
      
    </div>

    <!-- Boutons d'action -->
    <div class="bg-blue-50 p-4 border-t border-blue-200 rounded-b-xl">
      <div class="flex justify-between items-center">
        <div class="text-blue-700 text-sm font-semibold">
          Statut: 
          <span [class.text-green-600]="getTotalCauses() === getEcartCDP()"
                [class.text-red-600]="getTotalCauses() !== getEcartCDP()">
            {{ getTotalCauses() === getEcartCDP() ? 'Écart justifié ✓' : 'Écart non justifié ✗' }}
          </span>
        </div>
        
        <div class="flex space-x-2">
          <button (click)="closeCausesModal()"
                  type="button"
                  class="px-4 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg text-sm font-semibold transition-colors">
            Annuler
          </button>
          <button (click)="saveCauses()"
                  type="button"
                  class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-semibold transition-colors flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            Sauvegarder
          </button>
        </div>
      </div>
    </div>

  </div>
</div>

  <!-- Message de succès -->
  <div *ngIf="showSuccess()" class="success-notification">
    <div class="success-content">
      <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <span class="text-sm sm:text-base">{{ successMessage() }}</span>
    </div>
  </div>

  <!-- Loader global -->
  <div *ngIf="loading()" class="loader-overlay">
    <div class="loader-container">
      <div class="industrial-loader"></div>
      <p class="text-cyan-400 mt-4 font-semibold text-sm sm:text-base">Chargement...</p>
    </div>
  </div>
