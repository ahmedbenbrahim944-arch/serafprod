<div class="full-screen-layout text-white relative overflow-hidden">
  <!-- Background avec particules -->
  <div class="absolute inset-0 bg-cover bg-center bg-no-repeat opacity-10"
       style="background-image: url('https://www.tannerag.ch/Marketing/News%20and%20Social%20Media/38748/image-thumb__38748__contentImageLarge/production-process.e47f5cea.jpg')">
  </div>

  <!-- Système de particules -->
  <div class="absolute inset-0 pointer-events-none overflow-hidden">
    <div *ngFor="let particle of particles()" 
         class="particle absolute rounded-full bg-cyan-400/40"
         [style.left]="particle.left"
         [style.animation-delay]="particle.animationDelay"
         [style.width]="particle.size"
         [style.height]="particle.size"
         [style.opacity]="particle.opacity">
    </div>
  </div>

  <div class="relative z-10 h-screen flex flex-col">
    <!-- Header principal -->
    <header class="header-industrial py-3 px-4 sm:px-6">
      <div class="flex justify-between items-center">
        <button 
          (click)="goBackToLogin()"
          class="px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-red-600 hover:bg-red-500 text-white flex items-center text-xs sm:text-sm">
          <svg class="w-4 h-4 mr-1 sm:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
          <span class="hidden sm:inline">Retour</span>
        </button>

        <div class="text-center flex-1">
          <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-cyan-400">PLANIFICATION DES LIGNES</h1>
        </div>

        <div class="w-16 sm:w-32"></div>
      </div>
    </header>

    <!-- Contenu principal -->
    <div class="flex-1 flex overflow-hidden">
      
      <!-- Affichage des lignes de production -->
      <div *ngIf="!selectedLigne()" class="flex-1 p-2 sm:p-4 overflow-auto">
        <div class="max-w-[95%] mx-auto">
          
          <!-- Barre de recherche -->
          <div class="mb-4 sm:mb-6 flex justify-center">
            <div class="search-container p-2 sm:p-3 rounded-lg w-full max-w-md sm:w-96">
              <div class="flex items-center">
                <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input 
                  type="text" 
                  [value]="searchLineQuery()"
                  (input)="onSearchLineChange($event)"
                  placeholder="Rechercher une ligne..." 
                  class="search-input flex-1 text-sm sm:text-base">
                <button 
                  *ngIf="searchLineQuery()"
                  (click)="clearLineSearch()"
                  class="ml-2 text-gray-400 hover:text-white transition-colors">
                  <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="filteredLines().length === 0" class="text-center text-gray-400 py-8">
            <svg class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <p class="text-base sm:text-lg">Aucune ligne trouvée</p>
          </div>

          <!-- Grille responsive -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
            <div *ngFor="let line of filteredLines()" 
                 (click)="onLigneSelected(line)"
                 class="line-card-large rounded-xl cursor-pointer">
              <div class="image-container-large">
                <img [src]="line.imageUrl" [alt]="line.ligne">
                <div class="line-overlay-large">
                  <div class="line-name-large">{{ line.ligne }}</div>
                  <div class="text-cyan-200 text-xs sm:text-sm mt-2">{{ line.referenceCount }} références</div>
                </div>
                <div [class.status-badge-active]="line.isActive" 
                     [class.status-badge-inactive]="!line.isActive"
                     class="status-badge">
                  {{ line.isActive ? 'Active' : 'Inactive' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Affichage de la planification -->
      <div *ngIf="selectedLigne() && !selectedReferenceDetails()" class="flex-1 flex relative">
        
        <!-- BOUTON TOGGLE SIDEBAR -->
        <button 
          *ngIf="selectedLigne()"
          (click)="toggleSidebar()"
          class="toggle-sidebar-btn fixed z-30 bg-cyan-600 hover:bg-cyan-500 text-white rounded-r-lg transition-all duration-300 lg:hidden"
          [class.sidebar-open]="sidebarVisible()">
          <svg *ngIf="!sidebarVisible()" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          <svg *ngIf="sidebarVisible()" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>

        <!-- Sidebar des semaines -->
        <div 
          class="weeks-sidebar h-full overflow-y-auto custom-scrollbar transition-transform duration-300 lg:transform-none"
          [class.sidebar-hidden]="!sidebarVisible()"
          [class.sidebar-visible]="sidebarVisible()">
          <div class="p-3 sm:p-4">
            <button 
              (click)="backToLines()"
              class="w-full mb-4 sm:mb-6 px-3 sm:px-4 py-2 sm:py-3 rounded-lg font-semibold transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-white flex items-center justify-center text-xs sm:text-sm">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Retour aux lignes
            </button>

            <div class="mb-4 sm:mb-6 p-3 sm:p-4 bg-cyan-900/20 rounded-lg border border-cyan-700/30">
              <h3 class="font-bold text-cyan-400 text-lg sm:text-xl mb-2">{{ selectedLigne()!.ligne }}</h3>
              <p class="text-gray-300 text-xs sm:text-sm">{{ selectedLigne()!.referenceCount }} références disponibles</p>
            </div>

            <h4 class="text-cyan-300 font-semibold mb-3 sm:mb-4 text-xs sm:text-sm uppercase tracking-wider">Semaines disponibles</h4>
            <!-- Dans la sidebar des semaines -->
<!-- Dans planification.component.html - section sidebar des semaines -->
<div class="space-y-2">
  <div *ngIf="getAvailableWeeks().length === 0" class="text-center py-4">
    <div class="text-gray-400 mb-2">
      <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
      <p class="text-sm">Aucune semaine disponible</p>
    </div>
    <p class="text-xs text-gray-500">Créez des semaines dans l'interface admin</p>
  </div>
  
  <div *ngFor="let week of getAvailableWeeks()" 
       (click)="onWeekSelected(week.number)"
       [class.active]="selectedWeek() === week.number"
       class="week-item p-2 sm:p-3 rounded-lg cursor-pointer border border-gray-600/30 hover:border-cyan-500/50 transition-colors">
    <div class="font-bold text-white text-base sm:text-lg">
      Semaine {{ week.number }}
    </div>
    <div class="text-gray-400 text-xs mt-1">
      {{ week.startDate | date:'dd/MM' }} - {{ week.endDate | date:'dd/MM' }}
    </div>
    <div *ngIf="week.data" class="text-cyan-300 text-xs mt-1">
      {{ week.data.nom }}
    </div>
  </div>
</div>
        </div>
        </div>
        

        <!-- Overlay pour fermer sidebar -->
        <div 
          *ngIf="sidebarVisible()" 
          class="sidebar-overlay lg:hidden"
          (click)="toggleSidebar()">
        </div>

        <!-- Contenu de la semaine -->
        <div class="flex-1 p-3 sm:p-4 md:p-6 overflow-auto custom-scrollbar">
          <div *ngIf="weekPlanification()" class="mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
              <div>
                <h2 class="text-xl sm:text-2xl font-bold text-cyan-400 mb-2">
                  {{ selectedLigne()!.ligne }} - Semaine {{ selectedWeek() }}
                </h2>
                <p class="text-gray-400 text-sm sm:text-base">{{ filteredWeekPlanification()!.startDate | date:'dd/MM/yyyy' }} au {{ filteredWeekPlanification()!.endDate | date:'dd/MM/yyyy' }}</p>
              </div>
              
              <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:space-x-4">
                <div class="search-container p-2 sm:p-3 rounded-lg w-full sm:w-64">
                  <div class="flex items-center">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 search-icon mr-2 sm:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    <input 
                      type="text" 
                      [value]="searchReferenceQuery()"
                      (input)="onSearchReferenceChange($event)"
                      placeholder="Rechercher référence..." 
                      class="search-input flex-1 text-sm sm:text-base">
                    <button 
                      *ngIf="searchReferenceQuery()"
                      (click)="clearReferenceSearch()"
                      class="ml-2 text-gray-400 hover:text-white transition-colors">
                      <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <button 
                  (click)="toggleEditMode()"
                  [class.bg-green-600]="!isEditing()"
                  [class.bg-blue-600]="isEditing()"
                  class="px-4 sm:px-6 py-2 sm:py-3 rounded-lg font-semibold transition-all duration-300 text-white flex items-center justify-center text-sm sm:text-base">
                  <svg *ngIf="!isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                  <svg *ngIf="isEditing()" class="w-4 h-4 sm:w-5 sm:h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  {{ isEditing() ? 'Enregistrer' : 'Modifier' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Tableau de planification -->
          <div *ngIf="filteredWeekPlanification()" 
               class="table-responsive-container rounded-xl border-2 border-gray-700 bg-slate-900/60 shadow-2xl"
               #tableContainer
               [class.scrollable]="isScrollable()"
               [class.scrolled]="isScrolled()"
               [class.scrolled-end]="isScrolledEnd()"
               [class.scrolled-start]="!isScrolled()">
            
            <div class="table-scroll-wrapper" 
                 #scrollWrapper
                 (scroll)="onTableScroll($event)"
                 (touchstart)="onTouchStart($event)"
                 (touchmove)="onTouchMove($event)"
                 (touchend)="onTouchEnd()">
              
              <div class="planning-table-min-width">
                <table class="week-planning-table w-full">
                  
                 <thead>
  <tr>
    <th class="sticky left-0 z-20 sticky-cell border-2 border-gray-700" rowspan="2">RÉFÉRENCES</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">C/R</th>
    <th class="text-center border-2 font-bold border-gray-700" rowspan="2">OF</th>
    
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header" colspan="1">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
          <div class="text-center">
            <div class="font-bold text-cyan-400 capitalize text-sm sm:text-base">{{ day }}</div>
            <div class="text-xs sm:text-sm text-gray-300 mt-1">{{ getDayDateCorrected(weekDays[i], i) | date:'dd/MM' }}</div>
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
  <tr>
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header">
        <div class="flex flex-col items-center justify-center px-2 py-2">
          <span class="text-xs sm:text-sm text-gray-300 font-bold mb-1">NB OP</span>
          <!-- Carte bleue pour le nombre d'opérateurs dans l'en-tête -->
          <div class="bg-cyan-600/60 border-2 border-cyan-400 rounded-lg px-3 py-1.5 min-w-[50px]">
            <span class="text-white font-bold text-base">
              {{ getFirstNbOperateurs(day) }}
            </span>
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
</thead>
              <tbody>
  <ng-container *ngFor="let ref of filteredWeekPlanification()!.references">
    <!-- Ligne C avec NB OP affiché -->
    <tr class="border-b border-gray-700/50">
      <td (click)="showReferenceDetails(ref)" 
          class="sticky left-0 z-10 sticky-cell border-2 border-gray-700 font-semibold whitespace-nowrap px-2 sm:px-4 py-3 sm:py-4 text-sm sm:text-base cursor-pointer hover:bg-cyan-900/30 transition-colors" 
          rowspan="5">
        {{ ref.reference }}
      </td>
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">C</td>
      <td class="text-center font-mono text-white border-2 border-gray-700 py-3 sm:py-4 vertical-text-cell" rowspan="5">
        <div class="vertical-text-wrapper">
          <ng-container *ngIf="getDayEntry(ref, 'lundi')">
            <!-- OF - MODIFIABLE EN MODE ÉDITION -->
            <input *ngIf="isEditing()" 
                   [value]="getDayEntry(ref, 'lundi')!.of"
                   (input)="updateDayEntry(ref, 'lundi', 'of', $any($event.target).value)"
                   class="vertical-text-input">
            <span *ngIf="!isEditing()" class="vertical-text-value">{{ getDayEntry(ref, 'lundi')!.of }}</span>
          </ng-container>
        </div>
      </td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- C - MODIFIABLE EN MODE ÉDITION -->
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.c"
                 (input)="updateDayEntry(ref, day, 'c', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.c }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne M - NON MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">M</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- M - TOUJOURS EN LECTURE SEULE -->
          <span class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.m }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DP - NON MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DP</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- DP - TOUJOURS EN LECTURE SEULE -->
          <span class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.dp }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne DM - NON MODIFIABLE -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DM</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <!-- DM - TOUJOURS EN LECTURE SEULE -->
          <span class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.dm }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne Delta - NON MODIFIABLE -->
    <tr class="border-b-2 border-gray-700">
      <td class="text-center font-bold text-cyan-400 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">Δ</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <button *ngIf="getDayEntry(ref, day)"
                  (click)="openCausesModal(ref, day)"
                  type="button"
                  [ngClass]="{
                    'delta-excellent': getDayEntry(ref, day)!.delta >= 70,
                    'delta-good': getDayEntry(ref, day)!.delta >= 50 && getDayEntry(ref, day)!.delta < 70,
                    'delta-average': getDayEntry(ref, day)!.delta >= 20 && getDayEntry(ref, day)!.delta < 50,
                    'delta-poor': getDayEntry(ref, day)!.delta < 20
                  }"
                  class="font-bold delta-value text-base sm:text-lg w-full px-2 py-2 rounded-lg hover:scale-105 transition-transform cursor-pointer hover:shadow-lg relative group">
            {{ getDayEntry(ref, day)!.delta }}
            
            <!-- Indicateur vert si causes enregistrées -->
            <span *ngIf="hasCausesRegistered(ref, day)" 
                  class="absolute top-1 right-1 w-2 h-2 bg-green-400 rounded-full animate-pulse"
                  title="Causes enregistrées">
            </span>
            
            <!-- Tooltip au survol -->
            <span class="tooltip-text absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
              Cliquer pour voir les causes
            </span>
          </button>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
  </ng-container>
</tbody>
                </table>
              </div>
            </div>
            
            <!-- Indicateur de défilement -->
            <div class="scroll-indicator" 
                 *ngIf="showScrollIndicator()"
                 (click)="scrollToStart()">
              <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
              </svg>
              Glisser pour voir les jours
            </div>
          </div>

          <div *ngIf="selectedLigne() && !weekPlanification()" class="h-full flex items-center justify-center">
            <div class="text-center text-gray-400">
              <svg class="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <p class="text-base sm:text-lg mb-2">Sélectionnez une semaine</p>
              <p class="text-xs sm:text-sm text-gray-500">pour voir la planification</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Affichage des détails de référence -->
      <div *ngIf="selectedReferenceDetails()" class="flex-1 p-3 sm:p-4 md:p-6 overflow-auto">
        <div class="mb-4 sm:mb-6">
          <button 
            (click)="backToWeekPlanning()"
            class="px-3 sm:px-4 py-2 rounded-lg font-semibold transition-all duration-300 bg-gray-700 hover:bg-gray-600 text-white flex items-center text-xs sm:text-sm mb-4">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Retour au planning
          </button>

          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
            <div>
              <h2 class="text-xl sm:text-2xl font-bold text-cyan-400 mb-2">
                Détails de la référence {{ selectedReferenceDetails()!.reference }}
              </h2>
              <p class="text-gray-400 text-sm sm:text-base">{{ selectedLigne()!.ligne }} - Semaine {{ selectedWeek() }}</p>
            </div>
          </div>
        </div>

        <!-- Tableau des détails de référence -->
        <div class="overflow-x-auto rounded-xl border-2 border-gray-700 bg-slate-900/60 shadow-2xl">
          <table class="week-planning-table w-full">
            <thead>
  <tr>
    <th class="sticky left-0 z-20 sticky-cell border-2 border-gray-700" rowspan="2">RÉFÉRENCES</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">C/R</th>
    <th class="text-center border-2 border-gray-700" rowspan="2">OF</th>
    
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header" colspan="1">
        <div class="flex flex-col sm:flex-row items-center justify-center gap-2">
          <div class="text-center">
            <div class="font-bold text-cyan-400 capitalize text-sm sm:text-base">{{ day }}</div>
            <div class="text-xs sm:text-sm text-gray-300 mt-1">{{ getDayDate(i) | date:'dd/MM' }}</div>
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
  <tr>
    <ng-container *ngFor="let day of weekDays; let i = index">
      <th class="text-center border-2 border-gray-700 day-header">
        <div class="flex flex-col items-center justify-center px-2 py-2">
          <span class="text-xs sm:text-sm text-gray-300 font-bold mb-1">NB OP</span>
          <!-- Carte bleue pour le nombre d'opérateurs dans l'en-tête -->
          <div class="bg-cyan-600/60 border-2 border-cyan-400 rounded-lg px-3 py-1.5 min-w-[50px]">
            <span class="text-white font-bold text-base">
              {{ getFirstNbOperateurs(day) }}
            </span>
          </div>
        </div>
      </th>
    </ng-container>
  </tr>
</thead>
           <tbody>
  <ng-container *ngFor="let ref of filteredWeekPlanification()!.references">
    <!-- Ligne C avec NB OP affiché -->
    <tr class="border-b border-gray-700/50">
      <td (click)="showReferenceDetails(ref)" 
          class="sticky left-0 z-10 sticky-cell border-2 border-gray-700 font-semibold whitespace-nowrap px-2 sm:px-4 py-3 sm:py-4 text-sm sm:text-base cursor-pointer hover:bg-cyan-900/30 transition-colors" 
          rowspan="5">
        {{ ref.reference }}
      </td>
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">C</td>
      <td class="text-center font-mono text-white border-2 border-gray-700 py-3 sm:py-4 vertical-text-cell" rowspan="5">
  <div class="vertical-text-wrapper">
    <ng-container *ngIf="getOfForReference(ref)">
      <input *ngIf="isEditing()" 
             [value]="getOfForReference(ref)"
             (input)="updateOfForAllDays(ref, $any($event.target).value)"
             class="vertical-text-input"
             placeholder="OF">
      <span *ngIf="!isEditing()" class="vertical-text-value">
        {{ getOfForReference(ref) }}
      </span>
    </ng-container>
    <ng-container *ngIf="!getOfForReference(ref)">
      <input *ngIf="isEditing()" 
             (input)="updateOfForAllDays(ref, $any($event.target).value)"
             class="vertical-text-input"
             placeholder="OF">
      <span *ngIf="!isEditing()" class="vertical-text-value text-gray-500">-</span>
    </ng-container>
  </div>
</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4 relative">
          <!-- CARTE BLEUE AVEC NB OP -->
          <div class="flex flex-col items-center gap-2">
            <!-- Carte bleue pour NB OP -->
            <div class="bg-cyan-600/40 border border-cyan-400 rounded-lg px-3 py-2 min-w-[60px]">
              <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                     type="number"
                     [value]="getDayEntry(ref, day)!.nbOperateurs"
                     (input)="updateDayEntry(ref, day, 'nbOperateurs', $any($event.target).value)"
                     class="w-full bg-transparent border-none text-white text-center font-bold text-sm focus:outline-none focus:ring-1 focus:ring-cyan-300 rounded"
                     placeholder="0">
              <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                    class="text-white font-bold text-sm">
                {{ getDayEntry(ref, day)!.nbOperateurs || 0 }}
              </span>
              <span *ngIf="!getDayEntry(ref, day)" class="text-gray-400 text-xs">-</span>
            </div>
            
            <!-- Valeur C en dessous -->
            <div class="w-full">
              <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                     type="number"
                     [value]="getDayEntry(ref, day)!.c"
                     (input)="updateDayEntry(ref, day, 'c', $any($event.target).value)"
                     class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
              <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                    class="text-white font-bold text-base sm:text-lg value-display">
                {{ getDayEntry(ref, day)!.c }}
              </span>
              <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
            </div>
          </div>
        </td>
      </ng-container>
    </tr>
    
    <!-- Lignes M, DP, DM restent identiques -->
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">M</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.m"
                 (input)="updateDayEntry(ref, day, 'm', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.m }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DP</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.dp"
                 (input)="updateDayEntry(ref, day, 'dp', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.dp }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <tr class="border-b border-gray-700/50">
      <td class="text-center font-bold text-white border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">DM</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <input *ngIf="isEditing() && getDayEntry(ref, day)" 
                 type="number"
                 [value]="getDayEntry(ref, day)!.dm"
                 (input)="updateDayEntry(ref, day, 'dm', $any($event.target).value)"
                 class="w-full bg-gray-700/50 border border-cyan-500/40 rounded px-2 sm:px-3 py-1 sm:py-2 text-white text-base sm:text-lg text-center font-bold">
          <span *ngIf="!isEditing() && getDayEntry(ref, day)" 
                class="text-white font-bold text-base sm:text-lg value-display">
            {{ getDayEntry(ref, day)!.dm }}
          </span>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
    
    <!-- Ligne Delta -->
    <tr class="border-b-2 border-gray-700">
      <td class="text-center font-bold text-cyan-400 border-2 border-gray-700 py-3 sm:py-4 text-sm sm:text-base">Δ</td>
      <ng-container *ngFor="let day of weekDays">
        <td class="text-center border-2 border-gray-700 py-3 sm:py-4">
          <button *ngIf="getDayEntry(ref, day)"
                  (click)="openCausesModal(ref, day)"
                  type="button"
                  [ngClass]="{
                    'delta-excellent': getDayEntry(ref, day)!.delta >= 70,
                    'delta-good': getDayEntry(ref, day)!.delta >= 50 && getDayEntry(ref, day)!.delta < 70,
                    'delta-average': getDayEntry(ref, day)!.delta >= 20 && getDayEntry(ref, day)!.delta < 50,
                    'delta-poor': getDayEntry(ref, day)!.delta < 20
                  }"
                  class="font-bold delta-value text-base sm:text-lg w-full px-2 py-2 rounded-lg hover:scale-105 transition-transform cursor-pointer hover:shadow-lg relative group">
            {{ getDayEntry(ref, day)!.delta }}
            
            <span *ngIf="getDayEntry(ref, day)!.causes" 
                  class="absolute top-1 right-1 w-2 h-2 bg-green-400 rounded-full"
                  title="Causes enregistrées"></span>
          </button>
          <span *ngIf="!getDayEntry(ref, day)" class="text-gray-500 text-sm sm:text-base">-</span>
        </td>
      </ng-container>
    </tr>
  </ng-container>
</tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Modal des 5M Causes -->
<!-- Modal des 5M Causes - VERSION LECTURE SEULE -->
<div *ngIf="showCausesModal()" 
     class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
  <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-xl shadow-2xl w-full max-w-3xl border-2 border-cyan-600 causes-modal-content causes-modal-wrapper">
    
    <!-- Header -->
    <div class="bg-cyan-600 p-6 flex justify-between items-center rounded-t-xl">
      <div>
        <h2 class="text-2xl font-bold text-white">ANALYSE DES CAUSES - 5M (CONSULTATION)</h2>
        <p class="text-cyan-100 text-sm mt-1" *ngIf="selectedEntryForCauses()">
          {{ selectedEntryForCauses()!.reference.reference }} - 
          {{ selectedEntryForCauses()!.day | titlecase }}
        </p>
      </div>
      <button (click)="closeCausesModal()" 
              type="button"
              class="text-white hover:text-cyan-200 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Résumé de l'écart -->
    <div class="p-6 bg-slate-800/50 border-b border-slate-700">
      <div class="grid grid-cols-3 gap-4 text-center">
        <div class="bg-slate-900/80 p-4 rounded-lg border border-cyan-500/30">
          <div class="text-cyan-400 text-sm font-semibold mb-1">Quantité Planifiée (C)</div>
          <div class="text-white text-2xl font-bold">
            {{ getSelectedC() }}
          </div>
        </div>
        
        <div class="bg-slate-900/80 p-4 rounded-lg border border-orange-500/30">
          <div class="text-orange-400 text-sm font-semibold mb-1">Produit Fini (DP)</div>
          <div class="text-white text-2xl font-bold">
            {{ getSelectedDP() }}
          </div>
        </div>
        
        <div class="bg-slate-900/80 p-4 rounded-lg border border-red-500/30">
          <div class="text-red-400 text-sm font-semibold mb-1">Écart à Justifier</div>
          <div class="text-red-400 text-2xl font-bold">
            {{ getEcartCDP() }}
          </div>
        </div>
      </div>
    </div>

    <!-- Formulaire des 5M - LECTURE SEULE -->
    <div class="p-6 space-y-4 max-h-[400px] overflow-y-auto causes-modal-form-section">      
      <!-- M1: Matière première -->
      <div class="bg-slate-800/80 p-4 rounded-lg border border-cyan-500/40">
        <label class="block text-cyan-400 font-bold text-sm mb-3">M1: Matière première</label>
        <div class="flex items-center justify-center">
          <div class="bg-slate-700 border-2 border-cyan-500/40 rounded-lg px-4 py-3 text-white text-xl text-center font-bold w-32">
            {{ currentCauses().m1MatierePremiere }}
          </div>
        </div>
      </div>

      <!-- M2: Absence -->
      <div class="bg-slate-800/80 p-4 rounded-lg border border-red-500/40">
        <label class="block text-red-400 font-bold text-sm mb-3">M2: absence</label>
        <div class="flex items-center justify-center">
          <div class="bg-slate-700 border-2 border-red-500/40 rounded-lg px-4 py-3 text-white text-xl text-center font-bold w-32">
            {{ currentCauses().m2Absence }}
          </div>
        </div>
      </div>

      <!-- M2: Rendement -->
      <div class="bg-slate-800/80 p-4 rounded-lg border border-orange-500/40">
        <label class="block text-orange-400 font-bold text-sm mb-3">M2: Rendement</label>
        <div class="flex items-center justify-center">
          <div class="bg-slate-700 border-2 border-orange-500/40 rounded-lg px-4 py-3 text-white text-xl text-center font-bold w-32">
            {{ currentCauses().m2Rendement }}
          </div>
        </div>
      </div>

      <!-- M4: Maintenance -->
      <div class="bg-slate-800/80 p-4 rounded-lg border border-yellow-500/40">
        <label class="block text-yellow-400 font-bold text-sm mb-3">M4: maintenance</label>
        <div class="flex items-center justify-center">
          <div class="bg-slate-700 border-2 border-yellow-500/40 rounded-lg px-4 py-3 text-white text-xl text-center font-bold w-32">
            {{ currentCauses().m4Maintenance }}
          </div>
        </div>
      </div>

      <!-- M5: Qualité -->
      <div class="bg-slate-800/80 p-4 rounded-lg border border-purple-500/40">
        <label class="block text-purple-400 font-bold text-sm mb-3">M5: Qualité</label>
        <div class="flex items-center justify-center">
          <div class="bg-slate-700 border-2 border-purple-500/40 rounded-lg px-4 py-3 text-white text-xl text-center font-bold w-32">
            {{ currentCauses().m5Qualite }}
          </div>
        </div>
      </div>
    </div>

    <!-- Footer avec totaux -->
    <div class="p-6 bg-slate-800/50 border-t border-slate-700 rounded-b-xl">
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-slate-900/80 p-3 rounded-lg text-center border border-cyan-500/30">
          <div class="text-cyan-400 text-xs font-semibold mb-1">Total Causes</div>
          <div class="text-white text-xl font-bold">{{ getTotalCauses() }}</div>
        </div>
        
        <div class="bg-slate-900/80 p-3 rounded-lg text-center border border-red-500/30">
          <div class="text-red-400 text-xs font-semibold mb-1">Écart à Justifier</div>
          <div class="text-white text-xl font-bold">{{ getEcartCDP() }}</div>
        </div>
        
        <div class="bg-slate-900/80 p-3 rounded-lg text-center border"
             [ngClass]="{
               'border-green-500/30': getDifferenceRestante() === 0,
               'border-yellow-500/30': getDifferenceRestante() !== 0
             }">
          <div class="text-xs font-semibold mb-1"
               [ngClass]="{
                 'text-green-400': getDifferenceRestante() === 0,
                 'text-yellow-400': getDifferenceRestante() !== 0
               }">
            Différence
          </div>
          <div class="text-xl font-bold"
               [ngClass]="{
                 'text-green-400': getDifferenceRestante() === 0,
                 'text-yellow-400': getDifferenceRestante() !== 0
               }">
            {{ getDifferenceRestante() }}
          </div>
        </div>
      </div>

      <!-- Alerte si différence non nulle -->
      <div *ngIf="getDifferenceRestante() !== 0" 
           class="mb-4 p-3 bg-yellow-900/30 border border-yellow-600/50 rounded-lg flex items-start">
        <svg class="w-5 h-5 text-yellow-400 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <div>
          <div class="text-yellow-400 font-semibold text-sm">Attention</div>
          <div class="text-yellow-200 text-xs mt-1">
            La somme des causes ({{ getTotalCauses() }}) ne correspond pas à l'écart total ({{ getEcartCDP() }})
          </div>
        </div>
      </div>

      <!-- Bouton Fermer uniquement -->
      <div class="flex justify-end">
        <button (click)="closeCausesModal()"
                type="button"
                class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold transition-colors flex items-center">
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>
  </div>

  <!-- Message de succès -->
  <div *ngIf="showSuccess()" class="success-notification">
    <div class="success-content">
      <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2 sm:mr-3 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
      </svg>
      <span class="text-sm sm:text-base">{{ successMessage() }}</span>
    </div>
  </div>

  <!-- Loader global -->
  <div *ngIf="loading()" class="loader-overlay">
    <div class="loader-container">
      <div class="industrial-loader"></div>
      <p class="text-cyan-400 mt-4 font-semibold text-sm sm:text-base">Chargement...</p>
    </div>
  </div>
</div>